# Архитектура TeaBot v3.0

## Принципы SOLID

### 1. Single Responsibility Principle (SRP)
Каждый класс имеет одну ответственность:

- **Config**: Управление конфигурацией и валидацией
- **ForwardsRepository**: Работа с базой данных (CRUD операции)
- **Router/Handlers**: Обработка команд и сообщений
- **Logger**: Логирование

### 2. Open/Closed Principle (OCP)
Система открыта для расширения, закрыта для модификации:

- Новые команды добавляются через декораторы `@router.message(Command("..."))`
- Новые типы сообщений обрабатываются в `get_message_type()`
- Новые проверки добавляются в `cmd_tea()` без изменения существующего кода

### 3. Liskov Substitution Principle (LSP)
Все компоненты могут быть заменены на их подтипы без нарушения функциональности:

- `ForwardsRepository` может быть заменен на другую реализацию (PostgreSQL, MongoDB)
- Обработчики команд могут быть заменены на другие реализации

### 4. Interface Segregation Principle (ISP)
Интерфейсы разделены по функциональности:

- Отдельные методы для работы с forwards и bans
- Специализированные методы для каждой операции

### 5. Dependency Inversion Principle (DIP)
Зависимости инвертированы:

- Handlers зависят от абстракции `db_repo`, а не от конкретной реализации
- Конфигурация инжектируется через `config` объект

## Структурное программирование

### Модульная структура
```
src/
├── config.py          # Конфигурация
├── logger.py          # Логирование
├── database/
│   └── repository.py  # Работа с БД
├── handlers/
│   └── commands.py    # Обработчики команд
└── utils/
    └── helpers.py     # Вспомогательные функции
```

### Функциональное разделение
- **Валидация**: Проверка прав доступа, чата, лимитов
- **Бизнес-логика**: Обработка команд, работа с данными
- **Представление**: Форматирование сообщений, ответы пользователю

## Новый функционал

### Timeout между анонсами
- **Настройка**: `TIMEOUT_MINUTES` в конфигурации (по умолчанию 30 минут)
- **Проверка**: В `cmd_tea()` перед отправкой анонса
- **Хранение**: Время последней пересылки в таблице `forwards`

### Система банов
- **Команда**: `/ban @username hours [reason]`
- **Права**: Только для администраторов
- **Хранение**: Таблица `bans` с полями:
  - `user_id`, `username` - информация о пользователе
  - `banned_by`, `banned_by_username` - кто забанил
  - `reason` - причина бана
  - `ban_until` - до какого времени забанен
  - `is_active` - активен ли бан

### Проверки в команде /tea
1. **Права доступа**: Проверка чата
2. **Бан**: Проверка активного бана
3. **Timeout**: Проверка времени с последнего анонса
4. **Лимит**: Проверка дневного лимита
5. **Отправка**: Публикация в канал

## Расширяемость

### Добавление новых команд
```python
@router.message(Command("new_command"))
async def cmd_new_command(message: Message) -> None:
    # Валидация
    if not is_correct_chat(message):
        return
    
    # Бизнес-логика
    # ...
    
    # Ответ пользователю
    await message.answer("Response")
```

### Добавление новых проверок
Новые проверки добавляются в начало `cmd_tea()` перед существующими проверками.

### Добавление новых типов данных
Новые таблицы создаются в `_init_db()` метода `ForwardsRepository`.
