# Архитектура TeaBot v3.0

## Принципы SOLID

### 1. Single Responsibility Principle (SRP)
Каждый класс имеет одну ответственность:

- **Config**: Управление конфигурацией и валидацией
- **ForwardsRepository**: Работа с базой данных (CRUD операции)
- **Router/Handlers**: Обработка команд и сообщений
- **Logger**: Логирование

### 2. Open/Closed Principle (OCP)
Система открыта для расширения, закрыта для модификации:

- Новые команды добавляются через декораторы `@router.message(Command("..."))`
- Новые типы сообщений обрабатываются в `get_message_type()`
- Новые проверки добавляются в `cmd_tea()` без изменения существующего кода

### 3. Liskov Substitution Principle (LSP)
Все компоненты могут быть заменены на их подтипы без нарушения функциональности:

- `ForwardsRepository` может быть заменен на другую реализацию (PostgreSQL, MongoDB)
- Обработчики команд могут быть заменены на другие реализации

### 4. Interface Segregation Principle (ISP)
Интерфейсы разделены по функциональности:

- Отдельные методы для работы с forwards и bans
- Специализированные методы для каждой операции

### 5. Dependency Inversion Principle (DIP)
Зависимости инвертированы:

- Handlers зависят от абстракции `db_repo`, а не от конкретной реализации
- Конфигурация инжектируется через `config` объект

## Структурное программирование

### Модульная структура
```
src/
├── config.py          # Конфигурация
├── logger.py          # Логирование
├── database/
│   └── repository.py  # Работа с БД
├── handlers/
│   └── commands.py    # Обработчики команд
└── utils/
    ├── helpers.py     # Вспомогательные функции для форматирования, валидации и работы с цитатами
    └── charts.py      # Генерация графиков статистики через matplotlib
```

### Функциональное разделение
- **Валидация**: Проверка прав доступа, чата, лимитов
- **Бизнес-логика**: Обработка команд, работа с данными
- **Представление**: Форматирование сообщений, ответы пользователю
- **Визуализация**: Генерация графиков статистики через matplotlib

## Новый функционал

### Гибкие настройки доступа
- **Настройка**: Через переменные окружения для каждой команды
- **Команды**: `BAN_ADMIN_ONLY`, `UNBAN_ADMIN_ONLY`, `STATS_ADMIN_ONLY`, `RESET_ADMIN_ONLY`
- **Реализация**: Проверка в каждом обработчике команд

### Кастомная основная команда
- **Настройка**: `MAIN_COMMAND` в конфигурации (по умолчанию "tea")
- **Реализация**: Динамическое создание обработчика через `Command(config.MAIN_COMMAND)`
- **Справка**: Автоматическое обновление текста справки

### Управление логированием
- **Настройка**: `ENABLE_LOGGING` (true/false)
- **Реализация**: Условная инициализация хендлеров в `setup_logger()`
- **Fallback**: NullHandler при отключенном логировании

### Timeout между анонсами
- **Настройка**: `TIMEOUT_MINUTES` в конфигурации (по умолчанию 30 минут)
- **Проверка**: В `cmd_tea()` перед отправкой анонса
- **Хранение**: Время последней пересылки в таблице `forwards`

### Система банов
- **Команда**: `/ban @username hours [reason]`
- **Права**: Настраиваются через `BAN_ADMIN_ONLY`
- **Хранение**: Таблица `bans` с полями:
  - `user_id`, `username` - информация о пользователе
  - `banned_by`, `banned_by_username` - кто забанил
  - `reason` - причина бана
  - `ban_until` - до какого времени забанен
  - `is_active` - активен ли бан

### Проверки в основных командах (/tea, /quot)
1. **Права доступа**: Проверка чата
2. **Бан**: Проверка активного бана
3. **Timeout**: Проверка времени с последнего анонса
4. **Лимит**: Проверка дневного лимита
5. **Отправка**: Публикация в канал

### Конфигурация через переменные окружения

#### Основные настройки
- `BOT_TOKEN` - токен бота
- `GROUP_ID` - ID группы
- `CHANNEL_ID` - ID канала
- `ADMINS` - список администраторов

#### Настройки логирования
- `ENABLE_LOGGING` - включить/отключить логирование

#### Настройки команд
- `MAIN_COMMAND` - основная команда (по умолчанию "tea")
- `BAN_ADMIN_ONLY` - доступ к /ban (true/false)
- `UNBAN_ADMIN_ONLY` - доступ к /unban (true/false)
- `STATS_ADMIN_ONLY` - доступ к /stats (true/false)
- `RESET_ADMIN_ONLY` - доступ к /reset (true/false)

## Расширяемость

### Команда цитат (/quot)
- **Функциональность**: Публикует случайную цитату из файла `quotation.txt`
- **Реализация**: Аналогична команде `/tea`, но использует `format_quote_caption()`
- **Файл цитат**: `quotation.txt` в корне проекта
- **Формат**: Одна цитата на строку
- **Обработка ошибок**: Graceful fallback при недоступности файла

### Расширенная статистика (/stats)
- **Базовый вариант**: `/stats` - статистика за текущий месяц (без изменений)
- **Параметры команды**:
  - `/stats 1-12` - статистика за конкретный месяц с графиком по дням
  - `/stats year` - статистика за текущий год с графиком по месяцам
  - `/stats all` - статистика за все время
  - `/stats hour` - график активности по часам дня
  - `/stats weekday` - график активности по дням недели
- **Ограничения**: Доступна статистика только за последние 12 месяцев
- **Визуализация**: Столбчатые графики через matplotlib
- **Реализация**:
  - Новые методы в `ForwardsRepository` для получения статистики по периодам
  - Модуль `charts.py` для генерации графиков
  - Парсинг параметров команды в `cmd_stats()`
  - Отправка графиков как изображений через `answer_photo()`

### Добавление новых команд
```python
@router.message(Command("new_command"))
async def cmd_new_command(message: Message) -> None:
    # Валидация
    if not is_correct_chat(message):
        return
    
    # Бизнес-логика
    # ...
    
    # Ответ пользователю
    await message.answer("Response")
```

### Добавление новых проверок
Новые проверки добавляются в начало `cmd_tea()` перед существующими проверками.

### Добавление новых типов данных
Новые таблицы создаются в `_init_db()` метода `ForwardsRepository`.

### Методы статистики в ForwardsRepository
- `get_stats_by_month(month_number, year)` - статистика за месяц
- `get_stats_by_year(year)` - статистика за год с разбивкой по месяцам
- `get_stats_all_time()` - статистика за все время с разбивкой по годам
- `get_stats_by_hours(start_date, end_date)` - активность по часам (0-23)
- `get_stats_by_weekdays(start_date, end_date)` - активность по дням недели (0-6)
- `get_stats_by_days(month_number, year)` - активность по дням месяца
- `get_all_users_in_period(start_date, end_date)` - список всех участников за период

### Модуль charts.py
- `create_hours_chart()` - столбчатый график активности по часам
- `create_weekdays_chart()` - столбчатый график активности по дням недели
- `create_days_chart()` - столбчатый график активности по дням месяца
- `create_months_chart()` - столбчатый график активности по месяцам года
- Все функции возвращают `BytesIO` объект с изображением PNG
- Использует matplotlib с backend 'Agg' (без GUI)
